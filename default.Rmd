---
title: "R Notebook"
output: html_notebook
---

```{r}
# check if packages are installed, if not install them
if (!require("tidyverse")) install.packages("tidyverse")
if (!require("readxl")) install.packages("readxl")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("writexl")) install.packages("writexl")
library(tidyverse)
library(readxl)
library(ggplot2)
library(writexl)

# set system encoding to utf-8 to display "ä, ü, ö"
Sys.setlocale("LC_CTYPE", "en_US.UTF-8")

excel_input <- read_excel(file.choose())
excel_input_with_types <- read_excel(file.choose(), 
    col_types = c("text", "guess", "text", 
        "text", "text", "numeric", "guess", 
        "guess", "guess", "guess", "guess", 
        "guess", "guess", "guess", 
        "text"))

summary(excel_input_with_types)

oee_daten_p11 <- oee_daten_p11_raw %>%
                      # filter a column
                      filter(!is.na(colName)) %>%
                      filter(Störcode %in% c(31,32,33)) %>%
                      # filter a column with key characters
                      filter('...15' != "filterKey") %>%
                      # remove unnecessary columns
                      select(-'...t',-'colA', -'colB') %>%
                      # convert "Datum" and drop hours, minutes and seconds auto generated by readxl package
                      mutate(Datum = as.Date(Datum, format ='%Y/%m/%d')) %>%
                      # rename a column
                      rename(Dauer = 'Dauer Störung') %>%
                      # generate time different object
                      mutate(Dauer = difftime(Dauer,as.Date('1899-12-31 00:00:00'),  unit="secs")) %>%
                      # generate rowIDs
                      mutate(id = row_number()) %>%
                      # sort
                      arrange(desc(colName)) %>%
                      # add empty column
                      add_column(Kategorie =  "") %>%
                      # join another dataframe
                      inner_join(frame2, by = c("id" = "col_id")) %>%
                      # group 
                      group_by(Artikelname) %>%
                      # add count of each group for example
                      summarise(count = n(), .groups = 'drop') %>%
                      # generate a time span, to fill out missing day data
                      complete(Refdatum = seq.Date(as.Date("2020-01-01"), max(Refdatum), by="day")) %>% 
                      # generated aggregate "faelle" in previous steps is <na>, replace it by 0 cases
                      mutate(NeueFaelle = replace_na(NeueFaelle, 0)) %>% 
                      # library magic, easy cumsum bulding
                      mutate(GesamtFaelleLandkreis = cumsum(NeueFaelle)) %>%
                      # select no duplicate
                      distinct(IdLandkreis) %>%
                      # rename a column
                      rename(Name = `Name 2`) %>%

  
  
  
# TOP X example
amount_of_rows <- 15

article_top_x <- data.frame(
  Artikelname = article_csv[1:amount_of_rows,]$Artikelname,
  count = article_csv[1:amount_of_rows,]$count
)

# lock in factor level order to keep ordering
article_top_x$Artikelname <- factor(article_top_x$Artikelname, levels =article_top_x$Artikelname)


# nice looking plot with flipped coordinates
ggplot(article_top_x, aes(x=Artikelname, y=count, fill=Artikelname)) +
          # replace "700"" with suited value to extend max value of y-coord
          ylim(0, max(article_top_x$count) + 700) + 
          scale_x_discrete(limits = rev(levels(article_top_x$Artikelname)))+
          geom_bar(stat="identity", width=0.8 ) +
          # add discrete value besides bar
          geom_text(aes(label=count), hjust=-0.3, size=3.5)+
          # optinal flip coords
          coord_flip()+
          theme_minimal() + 
          theme(legend.position="none") +
          # add custom x and y labels
          xlab("Produktionsschritt") + ylab("Gesamtdauer in Minuten") +
          # title of the graph
          ggtitle("Top 15 produzierten Artikel - 01.08.19 - 31.07.20")


# save dataframe as excel file
write_xlsx(bem,"bem.xlsx")

```
